name: Sentry Source Maps Upload (Disabled)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

jobs:
  sentry-upload:
    if: false # Disabled - Sentry not configured for Vue Vite build now
    name: Upload Source Maps to Sentry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for better release tracking
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          # Sentry configuration for build
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          NODE_ENV: production

      - name: Upload source maps to Sentry
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
          version: ${{ github.sha }}
          sourcemaps: ".next/static"
          url_prefix: "~/_next/static"

      - name: Create Sentry release
        run: |
          # Install Sentry CLI
          npm install -g @sentry/cli

          # Create release
          sentry-cli releases new ${{ github.sha }}

          # Associate commits with release
          sentry-cli releases set-commits ${{ github.sha }} --auto

          # Upload source maps
          sentry-cli releases files ${{ github.sha }} upload-sourcemaps .next/static --url-prefix '~/_next/static'

          # Finalize release
          sentry-cli releases finalize ${{ github.sha }}

          # Create deployment
          sentry-cli releases deploys ${{ github.sha }} new -e ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sentry-build-artifacts
          path: |
            .next/
            sentry-debug-meta.properties
          retention-days: 7

  # Notify on deployment success/failure
  notify-sentry:
    if: false # Disabled
    name: Notify Sentry of Deployment
    runs-on: ubuntu-latest
    needs: sentry-upload

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Notify Sentry of deployment status
        run: |
          npm install -g @sentry/cli

          # Notify Sentry about deployment status
          if [ "${{ needs.sentry-upload.result }}" == "success" ]; then
            echo "✅ Deployment successful - notifying Sentry"
            sentry-cli releases deploys ${{ github.sha }} new -e ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }} --finished
          else
            echo "❌ Deployment failed - notifying Sentry"
            sentry-cli releases deploys ${{ github.sha }} new -e ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }} --finished --name "Failed Deployment"
          fi
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}

  # Test Sentry integration
  test-sentry:
    if: false # Disabled
    name: Test Sentry Integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Test build with Sentry
        run: npm run build
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          NODE_ENV: production

      - name: Verify Sentry configuration
        run: |
          # Check if Sentry configuration files exist
          if [ -f "sentry.client.config.js" ] && [ -f "sentry.server.config.js" ]; then
            echo "✅ Sentry configuration files found"
          else
            echo "❌ Sentry configuration files missing"
            exit 1
          fi

          # Check if source maps are generated
          if [ -d ".next/static" ]; then
            echo "✅ Build artifacts generated"
          else
            echo "❌ Build artifacts missing"
            exit 1
          fi
